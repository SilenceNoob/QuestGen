<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç­”é¢˜ç»“æœ - æ™ºèƒ½é¢˜ç›®ç”Ÿæˆç³»ç»Ÿ</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>ğŸ“Š ç­”é¢˜ç»“æœ</h1>
            <nav class="breadcrumb">
                <a href="{{ url_for('index') }}">é¦–é¡µ</a> > 
                <a href="{{ url_for('upload_document') }}">ä¸Šä¼ æ–‡æ¡£</a> > 
                <a href="{{ url_for('quiz') }}">åœ¨çº¿ç­”é¢˜</a> > ç­”é¢˜ç»“æœ
            </nav>
        </header>

        <main class="main-content">
            <!-- æ€»ä½“æˆç»© -->
            <div class="score-summary">
                <div class="score-card">
                    <div class="score-main">
                        <div class="score-circle">
                            <div class="score-number">{{ score_result.percentage }}%</div>
                            <div class="score-grade">{{ score_result.grade }}</div>
                        </div>
                        <div class="score-details">
                            <h2>æ€»ä½“æˆç»©</h2>
                            <p class="score-text">{{ score_result.total_score }} / {{ score_result.max_score }} åˆ†</p>
                            <p class="accuracy-text">æ­£ç¡®ç‡ï¼š{{ score_result.accuracy }}%</p>
                        </div>
                    </div>
                    
                    <div class="score-stats">
                        <div class="stat-item">
                            <span class="stat-label">æ€»é¢˜æ•°</span>
                            <span class="stat-value">{{ score_result.total_questions }}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">æ­£ç¡®é¢˜æ•°</span>
                            <span class="stat-value correct">{{ score_result.correct_count }}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">é”™è¯¯é¢˜æ•°</span>
                            <span class="stat-value incorrect">{{ score_result.total_questions - score_result.correct_count }}</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- åˆ†ç±»ç»Ÿè®¡ -->
            {% if statistics.by_type %}
            <div class="type-statistics">
                <h3>ğŸ“ˆ åˆ†ç±»ç»Ÿè®¡</h3>
                <div class="type-stats-grid">
                    {% for type_name, stats in statistics.by_type.items() %}
                    <div class="type-stat-card">
                        <h4>
                            {% if type_name == 'single_choice' %}
                                å•é€‰é¢˜
                            {% elif type_name == 'multiple_choice' %}
                                å¤šé€‰é¢˜
                            {% elif type_name == 'thinking' %}
                                æ€è€ƒé¢˜
                            {% else %}
                                åˆ¤æ–­é¢˜
                            {% endif %}
                        </h4>
                        <div class="type-accuracy">{{ stats.accuracy }}%</div>
                        <div class="type-count">{{ stats.correct }} / {{ stats.total }}</div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- è¯¦ç»†è§£æ -->
            <div class="detailed-results">
                <h3>ğŸ“ è¯¦ç»†è§£æ</h3>
                <div class="filter-tabs">
                    <button class="tab-btn active" data-filter="all">å…¨éƒ¨é¢˜ç›®</button>
                    <button class="tab-btn" data-filter="correct">æ­£ç¡®é¢˜ç›®</button>
                    <button class="tab-btn" data-filter="incorrect">é”™è¯¯é¢˜ç›®</button>
                </div>
                
                <div class="results-container">
                    {% for result in score_result.results %}
                    <div class="result-card {{ 'correct' if result.is_correct else 'incorrect' }}" data-result-type="{{ 'correct' if result.is_correct else 'incorrect' }}">
                        <div class="result-header">
                            <div class="question-info">
                                <span class="question-number">ç¬¬ {{ result.question_id }} é¢˜</span>
                                <span class="question-type">
                                    {% if result.question_type == 'single_choice' %}
                                        å•é€‰é¢˜
                                    {% elif result.question_type == 'multiple_choice' %}
                                        å¤šé€‰é¢˜
                                    {% elif result.question_type == 'thinking' %}
                                        æ€è€ƒé¢˜
                                    {% else %}
                                        åˆ¤æ–­é¢˜
                                    {% endif %}
                                </span>
                                <span class="result-status">
                                    {% if result.is_correct %}
                                        âœ… æ­£ç¡®
                                    {% else %}
                                        âŒ é”™è¯¯
                                    {% endif %}
                                </span>
                            </div>
                            <div class="score-info">
                                <span class="earned-score">{{ result.earned_score }}</span> / 
                                <span class="max-score">{{ result.max_score }}</span> åˆ†
                            </div>
                        </div>
                        
                        <div class="question-content">
                            <h4>{{ result.question }}</h4>
                        </div>
                        
                        {% if result.question_type == 'thinking' %}
                        <!-- æ€è€ƒé¢˜ç‰¹æ®Šæ˜¾ç¤º -->
                        <div class="thinking-answer-review">
                            <div class="user-thinking-answer">
                                <h5>æ‚¨çš„ç­”æ¡ˆï¼š</h5>
                                <div class="thinking-text">
                                    {% if result.user_answer %}
                                        {{ result.user_answer | replace('\n', '<br>') | safe }}
                                    {% else %}
                                        <span class="no-answer">æœªä½œç­”</span>
                                    {% endif %}
                                </div>
                            </div>
                            
                            {% if result.ai_feedback %}
                            <div class="ai-evaluation">
                                <h5>ğŸ¤– AIè¯„ä¼°åé¦ˆï¼š</h5>
                                <div class="ai-score">å¾—åˆ†ï¼š{{ result.ai_score }}/100</div>
                                <div class="ai-feedback-text">{{ result.ai_feedback }}</div>
                                {% if result.ai_key_points %}
                                <div class="ai-key-points">
                                    <strong>æ¶µç›–çš„å…³é”®ç‚¹ï¼š</strong>
                                    <ul>
                                        {% for point in result.ai_key_points %}
                                        <li>{{ point }}</li>
                                        {% endfor %}
                                    </ul>
                                </div>
                                {% endif %}
                                {% if result.ai_suggestions %}
                                <div class="ai-suggestions">
                                    <strong>æ”¹è¿›å»ºè®®ï¼š</strong>
                                    <ul>
                                        {% for suggestion in result.ai_suggestions %}
                                        <li>{{ suggestion }}</li>
                                        {% endfor %}
                                    </ul>
                                </div>
                                {% endif %}
                            </div>
                            {% endif %}
                            
                            <div class="reference-answer">
                                <h5>å‚è€ƒç­”æ¡ˆï¼š</h5>
                                <div class="reference-text">{{ result.correct_answer | replace('\n', '<br>') | safe }}</div>
                            </div>
                        </div>
                        {% else %}
                        <!-- é€‰æ‹©é¢˜æ˜¾ç¤º -->
                        <div class="options-review">
                            {% for option in result.options %}
                            {% set option_letter = option.split('.')[0] %}
                            <div class="option-item 
                                {% if result.question_type == 'multiple_choice' %}
                                    {% if option_letter in result.correct_answer %}
                                        correct-option
                                    {% endif %}
                                    {% if result.user_answer and option_letter in result.user_answer %}
                                        user-selected
                                        {% if option_letter not in result.correct_answer %}
                                            wrong-selection
                                        {% endif %}
                                    {% endif %}
                                {% else %}
                                    {% if option_letter == result.correct_answer %}
                                        correct-option
                                    {% endif %}
                                    {% if result.user_answer == option_letter %}
                                        user-selected
                                        {% if option_letter != result.correct_answer %}
                                            wrong-selection
                                        {% endif %}
                                    {% endif %}
                                {% endif %}
                            ">
                                <span class="option-text">{{ option }}</span>
                                <div class="option-indicators">
                                    {% if result.question_type == 'multiple_choice' %}
                                        {% if option_letter in result.correct_answer %}
                                            <span class="indicator correct">âœ“</span>
                                        {% endif %}
                                        {% if result.user_answer and option_letter in result.user_answer %}
                                            {% if option_letter in result.correct_answer %}
                                                <span class="indicator user-correct">ğŸ‘¤</span>
                                            {% else %}
                                                <span class="indicator user-wrong">ğŸ‘¤</span>
                                            {% endif %}
                                        {% endif %}
                                    {% else %}
                                        {% if option_letter == result.correct_answer %}
                                            <span class="indicator correct">âœ“</span>
                                        {% endif %}
                                        {% if result.user_answer == option_letter %}
                                            {% if option_letter == result.correct_answer %}
                                                <span class="indicator user-correct">ğŸ‘¤</span>
                                            {% else %}
                                                <span class="indicator user-wrong">ğŸ‘¤</span>
                                            {% endif %}
                                        {% endif %}
                                    {% endif %}
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% endif %}
                        
                        {% if result.question_type != 'thinking' %}
                        <div class="answer-summary">
                            <div class="answer-row">
                                <span class="answer-label">æ‚¨çš„ç­”æ¡ˆï¼š</span>
                                <span class="user-answer">
                                    {% if result.user_answer %}
                                        {% if result.question_type == 'multiple_choice' %}
                                            {{ result.user_answer | join(', ') }}
                                        {% else %}
                                            {{ result.user_answer }}
                                        {% endif %}
                                    {% else %}
                                        æœªä½œç­”
                                    {% endif %}
                                </span>
                            </div>
                            <div class="answer-row">
                                <span class="answer-label">æ­£ç¡®ç­”æ¡ˆï¼š</span>
                                <span class="correct-answer">
                                    {% if result.question_type == 'multiple_choice' %}
                                        {{ result.correct_answer | join(', ') }}
                                    {% else %}
                                        {{ result.correct_answer }}
                                    {% endif %}
                                </span>
                            </div>
                        </div>
                        {% endif %}
                        
                        {% if result.explanation %}
                        <div class="explanation">
                            <h5>ğŸ’¡ è§£æ</h5>
                            <p>{{ result.explanation }}</p>
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- æ“ä½œæŒ‰é’® -->
            <div class="result-actions">
                <a href="{{ url_for('upload_document') }}" class="btn btn-primary">
                    ğŸ”„ é‡æ–°å¼€å§‹
                </a>
                <button type="button" class="btn btn-secondary" id="printResult">
                    ğŸ–¨ï¸ æ‰“å°ç»“æœ
                </button>
                <a href="{{ url_for('restart') }}" class="btn btn-outline">
                    ğŸ  è¿”å›é¦–é¡µ
                </a>
            </div>
        </main>

        <footer class="footer">
            <p>&copy; 2025 æ™ºèƒ½é¢˜ç›®ç”Ÿæˆç³»ç»Ÿ</p>
        </footer>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // ç­›é€‰åŠŸèƒ½
            const filterTabs = document.querySelectorAll('.tab-btn');
            const resultCards = document.querySelectorAll('.result-card');
            
            filterTabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    // æ›´æ–°æ´»è·ƒæ ‡ç­¾
                    filterTabs.forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    
                    const filter = this.dataset.filter;
                    
                    // ç­›é€‰ç»“æœå¡ç‰‡
                    resultCards.forEach(card => {
                        if (filter === 'all') {
                            card.style.display = 'block';
                        } else {
                            const resultType = card.dataset.resultType;
                            card.style.display = resultType === filter ? 'block' : 'none';
                        }
                    });
                });
            });
            
            // æ‰“å°åŠŸèƒ½
            const printButton = document.getElementById('printResult');
            if (printButton) {
                printButton.addEventListener('click', function() {
                    window.print();
                });
            }
            
            // æˆç»©åœ†ç¯åŠ¨ç”»
            const scoreCircle = document.querySelector('.score-circle');
            if (scoreCircle) {
                const percentage = parseFloat("{{ score_result.percentage }}") || 0;
                
                // æ·»åŠ CSSå˜é‡ç”¨äºåŠ¨ç”»
                scoreCircle.style.setProperty('--percentage', percentage);
                
                // å»¶è¿Ÿæ·»åŠ åŠ¨ç”»ç±»
                setTimeout(() => {
                    scoreCircle.classList.add('animated');
                }, 500);
            }
        });
    </script>

    <style>
        @media print {
            .header nav,
            .result-actions,
            .footer {
                display: none;
            }
            
            .container {
                max-width: none;
                margin: 0;
                padding: 20px;
            }
            
            .result-card {
                break-inside: avoid;
                margin-bottom: 20px;
            }
        }
    </style>
</body>
</html>