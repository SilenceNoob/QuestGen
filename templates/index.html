<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½é¢˜ç›®ç”Ÿæˆç³»ç»Ÿ</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="header-content">
                <div>
                    <h1>ğŸ¯ æ™ºèƒ½é¢˜ç›®ç”Ÿæˆç³»ç»Ÿ</h1>
                    <p class="subtitle">åŸºäºæ–‡æ¡£å†…å®¹è‡ªåŠ¨ç”Ÿæˆå•é€‰é¢˜ã€å¤šé€‰é¢˜ã€åˆ¤æ–­é¢˜</p>
                </div>
                <div class="header-actions">
                    {% if session.is_admin %}
                        <span class="admin-badge">ç®¡ç†å‘˜: {{ session.admin_username }}</span>
                        <a href="{{ url_for('admin_dashboard') }}" class="btn btn-secondary">ç®¡ç†åå°</a>
                        <a href="{{ url_for('logout') }}" class="btn btn-outline">ç™»å‡º</a>
                    {% else %}
                        <a href="{{ url_for('login') }}" class="btn btn-outline">ç®¡ç†å‘˜ç™»å½•</a>
                    {% endif %}
                </div>
            </div>
        </header>

        <main class="main-content">
            <div class="welcome-section">
                <div class="feature-grid">
                    <div class="feature-card">
                        <div class="feature-icon">ğŸ“„</div>
                        <h3>æ–‡æ¡£ä¸Šä¼ </h3>
                        <p>æ”¯æŒçš„æ–‡æ¡£æ ¼å¼ï¼šTXTã€PDFã€DOCXã€MD</p>
                    </div>
                    <div class="feature-card">
                        <div class="feature-icon">ğŸ¤–</div>
                        <h3>AI ç”Ÿæˆé¢˜ç›®</h3>
                        <p>åŸºäº DeepSeek AI æ™ºèƒ½ç”Ÿæˆé«˜è´¨é‡é¢˜ç›®</p>
                    </div>
                    <div class="feature-card">
                        <div class="feature-icon">ğŸ“Š</div>
                        <h3>è‡ªåŠ¨è¯„åˆ†</h3>
                        <p>å³æ—¶è¯„åˆ†å¹¶æä¾›è¯¦ç»†çš„ç­”æ¡ˆè§£æ</p>
                    </div>
                </div>

                <div class="action-section">
                    <h2>å¼€å§‹ä½¿ç”¨</h2>
                    
                    {% if documents %}
                        <!-- æ–‡æ¡£é€‰æ‹©åŒºåŸŸ -->
                        <div class="document-selection">
                            <h3>ğŸ“š é€‰æ‹©å·²æœ‰æ–‡æ¡£ç”Ÿæˆé¢˜ç›®</h3>
                            <p>ä»ä»¥ä¸‹å·²ä¸Šä¼ çš„æ–‡æ¡£ä¸­é€‰æ‹©ä¸€ä¸ªæˆ–å¤šä¸ªä½œä¸ºé¢˜ç›®ç”Ÿæˆçš„å‚è€ƒï¼š</p>
                            
                            <div class="documents-grid" id="documentsGrid">
                                {% for doc in documents %}
                                <div class="document-item" data-filename="{{ doc.filename }}">
                                    <div class="document-icon">ğŸ“„</div>
                                    <div class="document-info">
                                        <div class="document-name">{{ doc.original_name }}</div>
                                        <div class="document-size">{{ "%.1f KB"|format(doc.size / 1024) }}</div>
                                    </div>
                                    <input type="checkbox" class="document-checkbox" value="{{ doc.filename }}">
                                </div>
                                {% endfor %}
                            </div>
                            
                            <div class="selection-actions">
                                <button id="selectAllBtn" class="btn btn-outline">å…¨é€‰</button>
                                <button id="clearSelectionBtn" class="btn btn-outline">æ¸…ç©º</button>
                                <button id="generateFromSelectionBtn" class="btn btn-primary" disabled>
                                    ğŸ¯ ç”Ÿæˆé¢˜ç›® (<span id="selectedCount">0</span>ä¸ªæ–‡æ¡£)
                                </button>
                            </div>
                        </div>
                        
                        <div class="divider">
                            <span>æˆ–è€…</span>
                        </div>
                    {% endif %}
                    
                    <!-- ä¸Šä¼ æ–°æ–‡æ¡£ -->
                    <div class="upload-section">
                        {% if session.is_admin %}
                            <h3>ğŸ“¤ ä¸Šä¼ æ–°æ–‡æ¡£</h3>
                            <p>ä¸Šä¼ æ–°çš„æ–‡æ¡£æ–‡ä»¶ï¼Œè®© AI ä¸ºæ‚¨ç”Ÿæˆä¸“ä¸šçš„æµ‹è¯•é¢˜ç›®</p>
                            <a href="{{ url_for('upload_document') }}" class="btn btn-primary btn-large">
                                ğŸ“¤ ä¸Šä¼ æ–‡æ¡£å¼€å§‹
                            </a>
                        {% else %}
                            <h3>ğŸ“¤ ä¸Šä¼ æ–‡æ¡£åŠŸèƒ½</h3>
                            <p>ä¸Šä¼ æ–‡æ¡£åŠŸèƒ½ä»…é™ç®¡ç†å‘˜ä½¿ç”¨ï¼Œè¯·å…ˆç™»å½•ç®¡ç†å‘˜è´¦æˆ·</p>
                            <a href="{{ url_for('login') }}" class="btn btn-secondary btn-large">
                                ğŸ” ç®¡ç†å‘˜ç™»å½•
                            </a>
                        {% endif %}
                    </div>
                </div>

                <div class="info-section">
                    <h3>ä½¿ç”¨è¯´æ˜</h3>
                    <ol class="steps-list">
                        <li><strong>ä¸Šä¼ æ–‡æ¡£ï¼š</strong>é€‰æ‹©æ‚¨è¦ç”Ÿæˆé¢˜ç›®çš„æ–‡æ¡£æ–‡ä»¶</li>
                        <li><strong>é…ç½®é¢˜ç›®ï¼š</strong>è®¾ç½®å•é€‰é¢˜ã€å¤šé€‰é¢˜ã€åˆ¤æ–­é¢˜çš„æ•°é‡</li>
                        <li><strong>ç”Ÿæˆé¢˜ç›®ï¼š</strong>AI å°†æ ¹æ®æ–‡æ¡£å†…å®¹ç”Ÿæˆç›¸åº”é¢˜ç›®</li>
                        <li><strong>åœ¨çº¿ç­”é¢˜ï¼š</strong>åœ¨ç½‘é¡µä¸Šå®Œæˆç­”é¢˜</li>
                        <li><strong>æŸ¥çœ‹ç»“æœï¼š</strong>è·å¾—è¯„åˆ†å’Œè¯¦ç»†çš„ç­”æ¡ˆè§£æ</li>
                    </ol>
                </div>

                <div class="supported-formats">
                    <h3>æ”¯æŒçš„æ–‡æ¡£æ ¼å¼</h3>
                    <div class="format-tags">
                        <span class="format-tag">ğŸ“„ TXT</span>
                        <span class="format-tag">ğŸ“• PDF</span>
                        <span class="format-tag">ğŸ“˜ DOCX</span>
                        <span class="format-tag">ğŸ“™ MD</span>
                    </div>
                </div>
            </div>
        </main>

        <footer class="footer">
            <p>&copy; 2025 æ™ºèƒ½é¢˜ç›®ç”Ÿæˆç³»ç»Ÿ | åŸºäº DeepSeek AI æŠ€æœ¯</p>
        </footer>
    </div>

    <style>
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .header-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .admin-badge {
            background: #28a745;
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: bold;
        }
        
        .btn-outline {
            background: transparent;
            border: 2px solid #007bff;
            color: #007bff;
        }
        
        .btn-outline:hover {
            background: #007bff;
            color: white;
        }
        
        .document-selection {
            background: #f8f9fa;
            padding: 2rem;
            border-radius: 8px;
            margin-bottom: 2rem;
        }
        
        .documents-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1rem;
            margin: 1.5rem 0;
        }
        
        .document-item {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .document-item:hover {
            border-color: #007bff;
            box-shadow: 0 2px 8px rgba(0,123,255,0.1);
        }
        
        .document-item.selected {
            border-color: #007bff;
            background: #e3f2fd;
        }
        
        .document-icon {
            font-size: 2rem;
        }
        
        .document-info {
            flex: 1;
        }
        
        .document-name {
            font-weight: bold;
            margin-bottom: 0.25rem;
        }
        
        .document-size {
            color: #666;
            font-size: 0.875rem;
        }
        
        .document-checkbox {
            width: 20px;
            height: 20px;
        }
        
        .selection-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 1.5rem;
        }
        
        .divider {
            text-align: center;
            margin: 2rem 0;
            position: relative;
        }
        
        .divider::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 1px;
            background: #ddd;
        }
        
        .divider span {
            background: white;
            padding: 0 1rem;
            color: #666;
        }
        
        .upload-section {
            text-align: center;
        }
        
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                text-align: center;
            }
            
            .documents-grid {
                grid-template-columns: 1fr;
            }
            
            .selection-actions {
                flex-direction: column;
                align-items: center;
            }
        }
    </style>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const checkboxes = document.querySelectorAll('.document-checkbox');
            const documentItems = document.querySelectorAll('.document-item');
            const selectAllBtn = document.getElementById('selectAllBtn');
            const clearSelectionBtn = document.getElementById('clearSelectionBtn');
            const generateBtn = document.getElementById('generateFromSelectionBtn');
            const selectedCountSpan = document.getElementById('selectedCount');
            
            function updateSelection() {
                const selectedCount = document.querySelectorAll('.document-checkbox:checked').length;
                selectedCountSpan.textContent = selectedCount;
                generateBtn.disabled = selectedCount === 0;
                
                // æ›´æ–°æ–‡æ¡£é¡¹çš„é€‰ä¸­çŠ¶æ€
                documentItems.forEach(item => {
                    const checkbox = item.querySelector('.document-checkbox');
                    if (checkbox.checked) {
                        item.classList.add('selected');
                    } else {
                        item.classList.remove('selected');
                    }
                });
            }
            
            // ç‚¹å‡»æ–‡æ¡£é¡¹åˆ‡æ¢é€‰ä¸­çŠ¶æ€
            documentItems.forEach(item => {
                item.addEventListener('click', function(e) {
                    if (e.target.type !== 'checkbox') {
                        const checkbox = this.querySelector('.document-checkbox');
                        checkbox.checked = !checkbox.checked;
                        updateSelection();
                    }
                });
            });
            
            // å¤é€‰æ¡†å˜åŒ–äº‹ä»¶
            checkboxes.forEach(checkbox => {
                checkbox.addEventListener('change', updateSelection);
            });
            
            // å…¨é€‰æŒ‰é’®
            if (selectAllBtn) {
                selectAllBtn.addEventListener('click', function() {
                    checkboxes.forEach(checkbox => {
                        checkbox.checked = true;
                    });
                    updateSelection();
                });
            }
            
            // æ¸…ç©ºé€‰æ‹©æŒ‰é’®
            if (clearSelectionBtn) {
                clearSelectionBtn.addEventListener('click', function() {
                    checkboxes.forEach(checkbox => {
                        checkbox.checked = false;
                    });
                    updateSelection();
                });
            }
            
            // ç”Ÿæˆé¢˜ç›®æŒ‰é’®
            if (generateBtn) {
                generateBtn.addEventListener('click', function() {
                    const selectedDocuments = Array.from(document.querySelectorAll('.document-checkbox:checked'))
                        .map(checkbox => checkbox.value);
                    
                    if (selectedDocuments.length === 0) {
                        alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªæ–‡æ¡£');
                        return;
                    }
                    
                    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                    this.disabled = true;
                    this.innerHTML = 'ğŸ”„ å¤„ç†ä¸­...';
                    
                    // å‘é€é€‰æ‹©çš„æ–‡æ¡£åˆ°åç«¯
                    fetch('/select_documents', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            selected_documents: selectedDocuments
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // è·³è½¬åˆ°é¢˜ç›®é…ç½®é¡µé¢
                            window.location.href = '/config';
                        } else {
                            alert('å¤„ç†å¤±è´¥: ' + data.error);
                            this.disabled = false;
                            this.innerHTML = 'ğŸ¯ ç”Ÿæˆé¢˜ç›® (<span id="selectedCount">' + selectedDocuments.length + '</span>ä¸ªæ–‡æ¡£)';
                        }
                    })
                    .catch(error => {
                        alert('å¤„ç†å¤±è´¥: ' + error);
                        this.disabled = false;
                        this.innerHTML = 'ğŸ¯ ç”Ÿæˆé¢˜ç›® (<span id="selectedCount">' + selectedDocuments.length + '</span>ä¸ªæ–‡æ¡£)';
                    });
                });
            }
        });
    </script>
</body>
</html>