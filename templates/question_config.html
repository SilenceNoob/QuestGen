<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¢˜ç›®æ•°é‡é…ç½® - æ™ºèƒ½é¢˜ç›®ç”Ÿæˆç³»ç»Ÿ</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>âš™ï¸ é¢˜ç›®æ•°é‡é…ç½®</h1>
            <nav class="breadcrumb">
                <a href="{{ url_for('index') }}">é¦–é¡µ</a> > 
                <a href="{{ url_for('admin_dashboard') }}">ç®¡ç†åå°</a> > 
                é¢˜ç›®æ•°é‡é…ç½®
            </nav>
        </header>

        <main class="main-content">
            <!-- æ˜¾ç¤ºæ¶ˆæ¯ -->
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="message {{ category }}">
                            {{ message }}
                        </div>
                    {% endfor %}
                {% endif %}
            {% endwith %}

            <div class="config-section">
                <h3>ğŸ“ å…¨å±€é¢˜ç›®æ•°é‡è®¾ç½®</h3>
                <p class="config-description">
                    è¿™é‡Œè®¾ç½®çš„é¢˜ç›®æ•°é‡å°†ä½œä¸ºæ‰€æœ‰ç”¨æˆ·ç”Ÿæˆé¢˜ç›®æ—¶çš„é»˜è®¤é…ç½®ã€‚
                    æ™®é€šç”¨æˆ·å°†ç›´æ¥ä½¿ç”¨è¿™äº›è®¾ç½®ç”Ÿæˆé¢˜ç›®ï¼Œæ— éœ€é¢å¤–é…ç½®ã€‚
                </p>
                
                <form id="questionConfigForm" class="config-form">
                    <div class="question-type">
                        <label for="singleChoice">å•é€‰é¢˜æ•°é‡ï¼š</label>
                        <input type="number" id="singleChoice" name="single_choice" min="0" max="10" value="{{ config.single_choice }}">
                        <span class="question-desc">æ¯é¢˜4ä¸ªé€‰é¡¹ï¼Œåªæœ‰1ä¸ªæ­£ç¡®ç­”æ¡ˆï¼ˆæœ€å¤š10é“ï¼‰</span>
                    </div>
                    
                    <div class="question-type">
                        <label for="multipleChoice">å¤šé€‰é¢˜æ•°é‡ï¼š</label>
                        <input type="number" id="multipleChoice" name="multiple_choice" min="0" max="8" value="{{ config.multiple_choice }}">
                        <span class="question-desc">æ¯é¢˜4ä¸ªé€‰é¡¹ï¼Œå¯èƒ½æœ‰å¤šä¸ªæ­£ç¡®ç­”æ¡ˆï¼ˆæœ€å¤š8é“ï¼‰</span>
                    </div>
                    
                    <div class="question-type">
                        <label for="trueFalse">åˆ¤æ–­é¢˜æ•°é‡ï¼š</label>
                        <input type="number" id="trueFalse" name="true_false" min="0" max="10" value="{{ config.true_false }}">
                        <span class="question-desc">åˆ¤æ–­å¯¹é”™ï¼Œåªæœ‰æ­£ç¡®æˆ–é”™è¯¯ä¸¤ä¸ªé€‰é¡¹ï¼ˆæœ€å¤š10é“ï¼‰</span>
                    </div>
                    
                    <div class="question-type">
                        <label for="thinking">æ€è€ƒé¢˜æ•°é‡ï¼š</label>
                        <input type="number" id="thinking" name="thinking" min="0" max="5" value="{{ config.thinking }}">
                        <span class="question-desc">å¼€æ”¾æ€§é—®é¢˜ï¼Œéœ€è¦æ–‡å­—å›ç­”ï¼ˆæœ€å¤š5é“ï¼Œé¿å…AIä¸Šä¸‹æ–‡é™åˆ¶ï¼‰</span>
                    </div>
                    
                    <div class="total-count">
                        <span>æ€»é¢˜ç›®æ•°é‡ï¼š<strong id="totalCount">{{ config.single_choice + config.multiple_choice + config.true_false + config.thinking }}</strong> é“</span>
                        <span class="limit-note">(æœ€å¤š20é“é¢˜)</span>
                    </div>
                    
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary" id="saveConfigBtn">
                            <span class="btn-text">ğŸ’¾ ä¿å­˜é…ç½®</span>
                        </button>
                        <a href="{{ url_for('admin_dashboard') }}" class="btn btn-secondary">
                            â†©ï¸ è¿”å›ç®¡ç†åå°
                        </a>
                    </div>
                </form>
            </div>

            <div class="current-config">
                <h3>ğŸ“Š å½“å‰é…ç½®</h3>
                <div class="config-summary">
                    <div class="config-item">
                        <span class="config-label">å•é€‰é¢˜ï¼š</span>
                        <span class="config-value">{{ config.single_choice }} é“</span>
                    </div>
                    <div class="config-item">
                        <span class="config-label">å¤šé€‰é¢˜ï¼š</span>
                        <span class="config-value">{{ config.multiple_choice }} é“</span>
                    </div>
                    <div class="config-item">
                        <span class="config-label">åˆ¤æ–­é¢˜ï¼š</span>
                        <span class="config-value">{{ config.true_false }} é“</span>
                    </div>
                    <div class="config-item">
                        <span class="config-label">æ€è€ƒé¢˜ï¼š</span>
                        <span class="config-value">{{ config.thinking }} é“</span>
                    </div>
                    <div class="config-item total">
                        <span class="config-label">æ€»è®¡ï¼š</span>
                        <span class="config-value">{{ config.single_choice + config.multiple_choice + config.true_false + config.thinking }} é“</span>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('questionConfigForm');
            const inputs = form.querySelectorAll('input[type="number"]');
            const totalCountElement = document.getElementById('totalCount');
            const saveBtn = document.getElementById('saveConfigBtn');
            
            // æ›´æ–°æ€»æ•°
            function updateTotalCount() {
                let total = 0;
                inputs.forEach(input => {
                    total += parseInt(input.value) || 0;
                });
                totalCountElement.textContent = total;
                
                // æ£€æŸ¥æ˜¯å¦è¶…è¿‡é™åˆ¶
                if (total > 20) {
                    totalCountElement.style.color = '#e53e3e';
                    saveBtn.disabled = true;
                } else if (total === 0) {
                    totalCountElement.style.color = '#e53e3e';
                    saveBtn.disabled = true;
                } else {
                    totalCountElement.style.color = '#38a169';
                    saveBtn.disabled = false;
                }
            }
            
            // ç›‘å¬è¾“å…¥å˜åŒ–
            inputs.forEach(input => {
                input.addEventListener('input', updateTotalCount);
            });
            
            // åˆå§‹åŒ–æ€»æ•°
            updateTotalCount();
            
            // è¡¨å•æäº¤
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const formData = new FormData(form);
                const config = {
                    single_choice: parseInt(formData.get('single_choice')) || 0,
                    multiple_choice: parseInt(formData.get('multiple_choice')) || 0,
                    true_false: parseInt(formData.get('true_false')) || 0,
                    thinking: parseInt(formData.get('thinking')) || 0
                };
                
                // éªŒè¯æ€»æ•°
                const total = Object.values(config).reduce((sum, val) => sum + val, 0);
                if (total === 0) {
                    alert('è¯·è‡³å°‘è®¾ç½®ä¸€ç§é¢˜å‹çš„æ•°é‡');
                    return;
                }
                if (total > 20) {
                    alert('é¢˜ç›®æ€»æ•°ä¸èƒ½è¶…è¿‡20é“');
                    return;
                }
                
                // æ˜¾ç¤ºä¿å­˜çŠ¶æ€
                saveBtn.disabled = true;
                saveBtn.innerHTML = '<span class="loading-spinner">âŸ³</span> ä¿å­˜ä¸­...';
                
                // å‘é€é…ç½®åˆ°åç«¯
                fetch('/save_question_config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(config)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('é…ç½®ä¿å­˜æˆåŠŸï¼');
                        window.location.reload();
                    } else {
                        alert('ä¿å­˜å¤±è´¥: ' + data.error);
                        saveBtn.disabled = false;
                        saveBtn.innerHTML = '<span class="btn-text">ğŸ’¾ ä¿å­˜é…ç½®</span>';
                    }
                })
                .catch(error => {
                    alert('ä¿å­˜å¤±è´¥: ' + error);
                    saveBtn.disabled = false;
                    saveBtn.innerHTML = '<span class="btn-text">ğŸ’¾ ä¿å­˜é…ç½®</span>';
                });
            });
        });
    </script>
</body>
</html>