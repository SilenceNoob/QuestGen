<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åœ¨çº¿ç­”é¢˜ - æ™ºèƒ½é¢˜ç›®ç”Ÿæˆç³»ç»Ÿ</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>ğŸ“ åœ¨çº¿ç­”é¢˜</h1>
            <nav class="breadcrumb">
                <a href="{{ url_for('index') }}">é¦–é¡µ</a> > 
                <a href="{{ url_for('upload_document') }}">ä¸Šä¼ æ–‡æ¡£</a> > åœ¨çº¿ç­”é¢˜
            </nav>
        </header>

        <main class="main-content">
            <div class="quiz-info">
                <div class="document-summary">
                    <h3>ğŸ“„ æ–‡æ¡£ä¿¡æ¯</h3>
                    <p><strong>æ–‡ä»¶åï¼š</strong>{{ document_info.filename }}</p>
                    <p><strong>å­—æ•°ï¼š</strong>{{ document_info.word_count }} å­—</p>
                </div>
                
                <div class="quiz-summary">
                    <h3>ğŸ“Š é¢˜ç›®ç»Ÿè®¡</h3>
                    <div class="stats-grid">
                        {% set single_count = questions|selectattr('type', 'equalto', 'single_choice')|list|length %}
                        {% set multiple_count = questions|selectattr('type', 'equalto', 'multiple_choice')|list|length %}
                        {% set tf_count = questions|selectattr('type', 'equalto', 'true_false')|list|length %}
                        {% set thinking_count = questions|selectattr('type', 'equalto', 'thinking')|list|length %}
                        
                        <div class="stat-item">
                            <span class="stat-label">å•é€‰é¢˜ï¼š</span>
                            <span class="stat-value">{{ single_count }} é“</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">å¤šé€‰é¢˜ï¼š</span>
                            <span class="stat-value">{{ multiple_count }} é“</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">åˆ¤æ–­é¢˜ï¼š</span>
                            <span class="stat-value">{{ tf_count }} é“</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">æ€è€ƒé¢˜ï¼š</span>
                            <span class="stat-value">{{ thinking_count }} é“</span>
                        </div>
                        <div class="stat-item total">
                            <span class="stat-label">æ€»è®¡ï¼š</span>
                            <span class="stat-value">{{ questions|length }} é“</span>
                        </div>
                    </div>
                </div>
            </div>

            <form id="quizForm" class="quiz-form">
                <div class="questions-container">
                    {% for question in questions %}
                    <div class="question-card" data-question-id="{{ question.id }}">
                        <div class="question-header">
                            <span class="question-number">ç¬¬ {{ question.id }} é¢˜</span>
                            <span class="question-type">
                                {% if question.type == 'single_choice' %}
                                    å•é€‰é¢˜
                                {% elif question.type == 'multiple_choice' %}
                                    å¤šé€‰é¢˜
                                {% elif question.type == 'thinking' %}
                                    æ€è€ƒé¢˜
                                {% else %}
                                    åˆ¤æ–­é¢˜
                                {% endif %}
                            </span>
                        </div>
                        
                        <div class="question-content">
                            <h4>{{ question.question }}</h4>
                        </div>
                        
                        <div class="options-container">
                            {% if question.type == 'thinking' %}
                                <div class="thinking-answer">
                                    <textarea name="question_{{ question.id }}" 
                                              class="thinking-textarea"
                                              placeholder="è¯·åœ¨æ­¤è¾“å…¥æ‚¨çš„æ€è€ƒå’Œåˆ†æ...ï¼ˆå»ºè®®è‡³å°‘100å­—ï¼‰"
                                              rows="6"></textarea>
                                    <div class="char-counter">
                                        <span class="current-chars">0</span> å­—
                                    </div>
                                </div>
                            {% else %}
                                {% for option in question.options %}
                                <label class="option-label">
                                    {% if question.type == 'multiple_choice' %}
                                        <input type="checkbox" 
                                               name="question_{{ question.id }}" 
                                               value="{{ option.split('.')[0] }}">
                                    {% else %}
                                        <input type="radio" 
                                               name="question_{{ question.id }}" 
                                               value="{{ option.split('.')[0] }}">
                                    {% endif %}
                                    <span class="option-text">{{ option }}</span>
                                </label>
                                {% endfor %}
                            {% endif %}
                        </div>
                        
                        <div class="question-progress">
                            <div class="progress-indicator" id="progress_{{ question.id }}">æœªä½œç­”</div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                
                <div class="quiz-actions">
                    <div class="progress-summary">
                        <span id="answeredCount">0</span> / {{ questions|length }} é¢˜å·²å®Œæˆ
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill"></div>
                        </div>
                    </div>
                    
                    <div class="action-buttons">
                        <button type="button" class="btn btn-secondary" id="saveProgress">
                            ğŸ’¾ ä¿å­˜è¿›åº¦
                        </button>
                        <button type="submit" class="btn btn-primary" id="submitQuiz">
                            <span class="btn-text">ğŸ“¤ æäº¤ç­”æ¡ˆ</span>
                            <span class="loading-spinner" style="display: none;">â³ è¯„åˆ†ä¸­...</span>
                        </button>
                    </div>
                </div>
            </form>
        </main>

        <footer class="footer">
            <p>&copy; 2024 æ™ºèƒ½é¢˜ç›®ç”Ÿæˆç³»ç»Ÿ</p>
        </footer>
    </div>

    <!-- æ¶ˆæ¯æç¤º -->
    <div class="message" id="message" style="display: none;">
        <span class="message-text" id="messageText"></span>
        <button class="message-close" id="messageClose">âœ•</button>
    </div>

    <!-- ç¡®è®¤å¯¹è¯æ¡† -->
    <div class="modal" id="confirmModal" style="display: none;">
        <div class="modal-content">
            <h3>ç¡®è®¤æäº¤</h3>
            <p id="confirmMessage"></p>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" id="cancelSubmit">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" id="confirmSubmit">ç¡®è®¤æäº¤</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const quizForm = document.getElementById('quizForm');
            const submitBtn = document.getElementById('submitQuiz');
            const saveBtn = document.getElementById('saveProgress');
            const answeredCount = document.getElementById('answeredCount');
            const progressFill = document.getElementById('progressFill');
            const confirmModal = document.getElementById('confirmModal');
            const confirmMessage = document.getElementById('confirmMessage');
            // è·å–é¢˜ç›®æ€»æ•°
            const totalQuestions = parseInt('{{ questions|length }}');
            
            // ç›‘å¬ç­”æ¡ˆå˜åŒ–
            quizForm.addEventListener('change', updateProgress);
            
            // æ›´æ–°è¿›åº¦
            function updateProgress() {
                let answered = 0;
                
                for (let i = 1; i <= totalQuestions; i++) {
                    const progressIndicator = document.getElementById(`progress_${i}`);
                    const questionType = getQuestionType(i);
                    
                    let hasAnswer = false;
                    
                    if (questionType === 'thinking') {
                        // æ€è€ƒé¢˜ï¼šæ£€æŸ¥textareaæ˜¯å¦æœ‰å†…å®¹
                        const textarea = document.querySelector(`textarea[name="question_${i}"]`);
                        if (textarea && textarea.value.trim()) {
                            hasAnswer = true;
                        }
                    } else {
                        // å…¶ä»–é¢˜å‹ï¼šæ£€æŸ¥inputæ˜¯å¦è¢«é€‰ä¸­
                        const questionInputs = document.querySelectorAll(`input[name="question_${i}"]`);
                        questionInputs.forEach(input => {
                            if (input.checked) {
                                hasAnswer = true;
                            }
                        });
                    }
                    
                    if (hasAnswer) {
                        answered++;
                        progressIndicator.textContent = 'å·²å®Œæˆ';
                        progressIndicator.className = 'progress-indicator completed';
                    } else {
                        progressIndicator.textContent = 'æœªä½œç­”';
                        progressIndicator.className = 'progress-indicator';
                    }
                }
                
                answeredCount.textContent = answered;
                const percentage = (answered / totalQuestions) * 100;
                progressFill.style.width = percentage + '%';
            }
            
            // ä¿å­˜è¿›åº¦
            saveBtn.addEventListener('click', function() {
                const answers = collectAnswers();
                localStorage.setItem('quiz_progress', JSON.stringify(answers));
                showMessage('è¿›åº¦å·²ä¿å­˜', 'success');
            });
            
            // åŠ è½½ä¿å­˜çš„è¿›åº¦
            function loadProgress() {
                const saved = localStorage.getItem('quiz_progress');
                if (saved) {
                    try {
                        const answers = JSON.parse(saved);
                        restoreAnswers(answers);
                        updateProgress();
                        showMessage('å·²æ¢å¤ä¸Šæ¬¡ä¿å­˜çš„è¿›åº¦', 'info');
                    } catch (e) {
                        console.error('Failed to load progress:', e);
                    }
                }
            }
            
            // æ”¶é›†ç­”æ¡ˆ
            function collectAnswers() {
                const answers = {};
                
                for (let i = 1; i <= totalQuestions; i++) {
                    const questionType = getQuestionType(i);
                    
                    if (questionType === 'thinking') {
                        // æ€è€ƒé¢˜ï¼šè·å–textareaçš„å€¼
                        const textarea = document.querySelector(`textarea[name="question_${i}"]`);
                        if (textarea && textarea.value.trim()) {
                            answers[i] = textarea.value.trim();
                        }
                    } else {
                        // å…¶ä»–é¢˜å‹ï¼šè·å–é€‰ä¸­çš„é€‰é¡¹
                        const questionInputs = document.querySelectorAll(`input[name="question_${i}"]`);
                        
                        if (questionType === 'multiple_choice') {
                            const selected = [];
                            questionInputs.forEach(input => {
                                if (input.checked) {
                                    selected.push(input.value);
                                }
                            });
                            if (selected.length > 0) {
                                answers[i] = selected;
                            }
                        } else {
                            questionInputs.forEach(input => {
                                if (input.checked) {
                                    answers[i] = input.value;
                                }
                            });
                        }
                    }
                }
                
                return answers;
            }
            
            // æ¢å¤ç­”æ¡ˆ
            function restoreAnswers(answers) {
                Object.keys(answers).forEach(questionId => {
                    const answer = answers[questionId];
                    const questionType = getQuestionType(questionId);
                    
                    if (questionType === 'thinking') {
                        // æ€è€ƒé¢˜ï¼šæ¢å¤textareaçš„å€¼
                        const textarea = document.querySelector(`textarea[name="question_${questionId}"]`);
                        if (textarea && typeof answer === 'string') {
                            textarea.value = answer;
                            updateCharCounter(textarea);
                        }
                    } else {
                        // å…¶ä»–é¢˜å‹ï¼šæ¢å¤é€‰ä¸­çŠ¶æ€
                        const questionInputs = document.querySelectorAll(`input[name="question_${questionId}"]`);
                        
                        if (Array.isArray(answer)) {
                            // å¤šé€‰é¢˜
                            questionInputs.forEach(input => {
                                input.checked = answer.includes(input.value);
                            });
                        } else {
                            // å•é€‰é¢˜å’Œåˆ¤æ–­é¢˜
                            questionInputs.forEach(input => {
                                input.checked = input.value === answer;
                            });
                        }
                    }
                });
            }
            
            // è·å–é¢˜ç›®ç±»å‹
            function getQuestionType(questionId) {
                const questionCard = document.querySelector(`[data-question-id="${questionId}"]`);
                const typeSpan = questionCard.querySelector('.question-type');
                const typeText = typeSpan.textContent.trim();
                
                if (typeText === 'å¤šé€‰é¢˜') return 'multiple_choice';
                if (typeText === 'åˆ¤æ–­é¢˜') return 'true_false';
                if (typeText === 'æ€è€ƒé¢˜') return 'thinking';
                return 'single_choice';
            }
            
            // æäº¤ç­”æ¡ˆ
            quizForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const answers = collectAnswers();
                const answeredQuestions = Object.keys(answers).length;
                const unansweredCount = totalQuestions - answeredQuestions;
                
                if (unansweredCount > 0) {
                    confirmMessage.textContent = `è¿˜æœ‰ ${unansweredCount} é“é¢˜æœªä½œç­”ï¼Œç¡®å®šè¦æäº¤å—ï¼Ÿ`;
                } else {
                    confirmMessage.textContent = 'ç¡®å®šè¦æäº¤ç­”æ¡ˆå—ï¼Ÿæäº¤åå°†æ— æ³•ä¿®æ”¹ã€‚';
                }
                
                confirmModal.style.display = 'flex';
                
                document.getElementById('confirmSubmit').onclick = function() {
                    confirmModal.style.display = 'none';
                    submitAnswers(answers);
                };
                
                document.getElementById('cancelSubmit').onclick = function() {
                    confirmModal.style.display = 'none';
                };
            });
            
            // æäº¤ç­”æ¡ˆåˆ°æœåŠ¡å™¨
            async function submitAnswers(answers) {
                setLoading(submitBtn, true);
                
                try {
                    const response = await fetch('/submit_answers', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ answers: answers })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        // æ¸…é™¤ä¿å­˜çš„è¿›åº¦
                        localStorage.removeItem('quiz_progress');
                        showMessage('æäº¤æˆåŠŸï¼æ­£åœ¨è·³è½¬åˆ°ç»“æœé¡µé¢...', 'success');
                        setTimeout(() => {
                            window.location.href = '/result';
                        }, 1500);
                    } else {
                        showMessage(result.error, 'error');
                    }
                } catch (error) {
                    showMessage('æäº¤å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
                } finally {
                    setLoading(submitBtn, false);
                }
            }
            
            // å·¥å…·å‡½æ•°
            function setLoading(button, loading) {
                const text = button.querySelector('.btn-text');
                const spinner = button.querySelector('.loading-spinner');
                
                if (loading) {
                    text.style.display = 'none';
                    spinner.style.display = 'inline';
                    button.disabled = true;
                } else {
                    text.style.display = 'inline';
                    spinner.style.display = 'none';
                    button.disabled = false;
                }
            }
            
            function showMessage(text, type) {
                const message = document.getElementById('message');
                const messageText = document.getElementById('messageText');
                
                messageText.textContent = text;
                message.className = `message ${type}`;
                message.style.display = 'flex';
                
                setTimeout(() => {
                    message.style.display = 'none';
                }, 5000);
            }
            
            document.getElementById('messageClose').addEventListener('click', () => {
                document.getElementById('message').style.display = 'none';
            });
            
            // å­—ç¬¦è®¡æ•°å™¨åŠŸèƒ½
            function updateCharCounter(textarea) {
                const counter = textarea.nextElementSibling;
                if (counter && counter.classList.contains('char-counter')) {
                    const currentLength = textarea.value.length;
                    const maxLength = textarea.getAttribute('maxlength') || 1000;
                    counter.textContent = `${currentLength}/${maxLength}`;
                    
                    // æ ¹æ®å­—ç¬¦æ•°é‡æ”¹å˜é¢œè‰²
                    if (currentLength > maxLength * 0.9) {
                        counter.style.color = '#dc3545';
                    } else if (currentLength > maxLength * 0.7) {
                        counter.style.color = '#ffc107';
                    } else {
                        counter.style.color = '#6c757d';
                    }
                }
            }
            
            // ä¸ºæ‰€æœ‰æ€è€ƒé¢˜çš„textareaæ·»åŠ å­—ç¬¦è®¡æ•°ç›‘å¬
            document.querySelectorAll('textarea[name^="question_"]').forEach(textarea => {
                textarea.addEventListener('input', function() {
                    updateCharCounter(this);
                    updateProgress(); // æ›´æ–°è¿›åº¦çŠ¶æ€
                });
                // åˆå§‹åŒ–è®¡æ•°å™¨
                updateCharCounter(textarea);
            });
            
            // é¡µé¢åŠ è½½æ—¶æ¢å¤è¿›åº¦
            loadProgress();
            updateProgress();
        });
    </script>
</body>
</html>